name: Ne10 ARM Builds and Benchmark

on:
  push:
  pull_request:

env:
  ITERATIONS: 10

jobs:
  build-armv7:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make build scripts executable
        run: chmod +x scripts/*.sh

      - name: Install cross-compile tools and QEMU for ARMv7
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabi g++-arm-linux-gnueabi \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            cmake git make \
            qemu-user qemu-user-static

      - name: Verify qemu-arm installation
        run: qemu-arm --version

      - name: Build ARMv7-A (hard float)
        run: ./scripts/ne10_build_armv7a_hard.sh

      # фиксированная точка
      - name : Build ARMv7-A (fix hard) 
        run : scripts/ne10_fix16_armv7a_hard.sh

      - name: List files in bin (ARMv7)
        run: ls -la bin/

      - name: Run ARMv7 hard float benchmark in QEMU
        run: |
          qemu-arm -L /usr/arm-linux-gnueabihf bin/ne10_bench_armv7a_hard_float $ITERATIONS \
          > bin/qemu_bench_armv7_hard.log 2>&1 || echo "QEMU returned error, but continuing"


      # фиксированная точка
      - name: Run ARMv7 hard fixed binary in QEMU
        run: |
          qemu-arm -L /usr/arm-linux-gnueabihf bin/ne10_fix16 $ITERATIONS \
            > bin/ne10_fix16.log 2>&1 || echo "QEMU returned error, but continuing"

      # фиксированная точка
      - name: Run ne10_fix16 binary and save logs
        run: |
          ./bin/ne10_fix16 > ./bin/ne10_fix16.log 2>&1

      # фиксированная точка
      - name: Upload ne10_fix16 logs
        uses: actions/upload-artifact@v4
        with:
          name: ne10_fix16-logs
          path: bin/ne10_fix16.log


      - name: Upload ARMv7 binaries
        uses: actions/upload-artifact@v4
        with:
          name: ne10-binaries-armv7
          path: bin/ne10_bench_armv7a_hard_float

      - name: Upload ARMv7 QEMU logs
        uses: actions/upload-artifact@v4
        with:
          name: ne10-benchmark-logs-armv7
          path: bin/qemu_bench_armv7_hard.log

  build-armv8:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make build scripts executable
        run: chmod +x scripts/*.sh

      - name: Install cross-compile tools and QEMU for ARMv8
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi g++-arm-linux-gnueabi \
            cmake git make \
            qemu-user qemu-user-static

      - name: Verify qemu-aarch64 installation
        run: qemu-aarch64 --version

      - name: Build ARMv8-A (hard float)
        run: ./scripts/ne10_build_armv8a_hard.sh

      - name: List files in bin (ARMv8)
        run: ls -la bin/

      - name: Run ARMv8 hard float benchmark in QEMU
        run: |
          qemu-aarch64 -L /usr/aarch64-linux-gnu bin/ne10_bench_armv8a_hard_float $ITERATIONS \
          > bin/qemu_bench_armv8_hard.log 2>&1 || echo "QEMU returned error, but continuing"

      - name: Upload ARMv8 binaries
        uses: actions/upload-artifact@v4
        with:
          name: ne10-binaries-armv8
          path: bin/ne10_bench_armv8a_hard_float

      - name: Upload ARMv8 QEMU logs
        uses: actions/upload-artifact@v4
        with:
          name: ne10-benchmark-logs-armv8
          path: bin/qemu_bench_armv8_hard.log
